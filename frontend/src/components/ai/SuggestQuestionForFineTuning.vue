<template>
  <h2>Suggest This Question For AI Fine Tuning</h2>
  <p>
    <i
      >Sending this question for fine tuning the question generation model will
      make this note and question visible to admin. Are you sure?</i
    >
  </p>
  <div>
    <label> This question is: </label>
    <button
      class="positive-feedback-btn feedback-btn"
      :class="{ selected: isPositiveFeedback }"
      @click="markQuestionAsPositive"
    >
      üëç Good
    </button>
    <button
      class="negative-feedback-btn feedback-btn"
      :class="{ selected: isPositiveFeedback === false }"
      @click="markQuestionAsNegative"
    >
      üëé Bad
    </button>
  </div>
  <TextInput
    id="feedback-comment"
    field="comment"
    v-model="comment"
    placeholder="Add a comment about the question"
  />
  <div class="feedback-actions-container">
    <button
      class="suggest-fine-tuning-ok-btn btn btn-success"
      @click="suggestQuestionForFineTuning"
    >
      OK
    </button>
    <div
      class="suggestion-sent-successfully-message"
      v-if="suggestionSubmittedSuccessfully"
    >
      Feedback sent successfully!
    </div>
    <div class="feedback-required-message" v-if="suggestionIsRequired">
      Feedback is required!
    </div>
    <div class="feedback-exist-message" v-if="existingFeedbackErrorMessage">
      Feedback already exist for this question!
    </div>
  </div>
</template>
<script setup lang="ts">
import { ref } from "vue";
import useLoadingApi from "../../managedApi/useLoadingApi";
// import asPopup from "../commons/Popups/asPopup";

const isPositiveFeedback = ref<boolean | null>(null);
const comment = ref<string>("");
const suggestionSubmittedSuccessfully = ref<boolean>(false);
const suggestionIsRequired = ref<boolean>(false);
const existingFeedbackErrorMessage = ref<boolean>(false);
const { api } = useLoadingApi();
// const { popup } = asPopup();

const props = defineProps<{
  quizQuestion: Generated.QuizQuestion | undefined;
}>();

const { quizQuestion } = props;

async function suggestQuestionForFineTuning() {
  try {
    suggestionIsRequired.value = false;
    suggestionSubmittedSuccessfully.value = false;
    existingFeedbackErrorMessage.value = false;

    if (isPositiveFeedback.value != null) {
      await api.reviewMethods.suggestQuestionForFineTuning(
        quizQuestion!.quizQuestionId,
        {
          isPositiveFeedback: isPositiveFeedback.value ?? false,
          comment: comment.value,
          isDuplicated: false,
        },
      );

      suggestionSubmittedSuccessfully.value = true;
      // popup.done(null);
    } else {
      suggestionIsRequired.value = true;
    }
  } catch (err) {
    // eslint-disable-next-line @typescript-eslint/no-explicit-any
    if ((err as any).errorType === "EXISTING_FEEDBACK_ERROR") {
      existingFeedbackErrorMessage.value = true;
    }

    suggestionSubmittedSuccessfully.value = false;
  }
}

function markQuestionAsPositive() {
  suggestionIsRequired.value = false;
  isPositiveFeedback.value = true;
}

function markQuestionAsNegative() {
  suggestionIsRequired.value = false;
  isPositiveFeedback.value = false;
}
</script>
<script lang="ts">
export default {
  name: "SuggestQuestionForFineTuningIntegrated",
  inheritAttrs: false,
  customOptions: {},
};
</script>
<style scoped>
.container {
  padding: 20px;
}
.feedback-btn {
  background-color: #007bff;
  color: white;
  padding: 5px;
  margin: 5px;
  border-radius: 5px;
}
.positive-feedback-btn.feedback-btn.selected {
  background-color: green;
}
.negative-feedback-btn.feedback-btn.selected {
  background-color: red;
}
.feedback-actions-container {
  display: flex;
  align-items: center;
}
.suggestion-sent-successfully-message {
  margin-left: 10px;
  padding: 10px;
  border-radius: 5px;
  background-color: green;
  color: white;
}
</style>
